{% extends "base_ros2.html" %}

{% block title %}PTZ 控制面板 - PTZ 控制系统 (ROS2){% endblock %}

{% block extra_css %}
<style>
    .status-display {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .sample-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    .sample-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
        min-height: 160px; /* 改为最小高度 */
    }
    .sample-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-color: #007bff;
    }
    .sample-card.selected {
        border-color: #28a745;
        background-color: #d4edda;
    }
    .sample-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
        object-position: center;
    }
    .sample-content {
        min-height: 160px; /* 改为最小高度 */
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1rem;
        background: white; /* 确保有背景 */
    }
    .execute-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        padding: 0.75rem 2rem;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    .execute-btn:hover {
        background: linear-gradient(45deg, #218838, #1ea085);
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(40, 167, 69, 0.3);
    }
    .execute-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .ros-topic-info {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0.25rem;
    }
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    .status-online {
        background-color: #28a745;
        animation: pulse-green 2s infinite;
    }
    .status-offline {
        background-color: #dc3545;
    }
    .status-warning {
        background-color: #ffc107;
        animation: pulse-yellow 2s infinite;
    }
    @keyframes pulse-green {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    @keyframes pulse-yellow {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    .command-history {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
    }
    .command-entry {
        border-bottom: 1px solid #dee2e6;
        padding: 0.5rem 0;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    .command-entry:last-child {
        border-bottom: none;
    }
    .timestamp {
        font-size: 0.85em;
        color: #6c757d;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        z-index: 10;
    }
    
    /* 状态横栏样式 */
    .status-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .status-overview .card-body {
        padding: 1.5rem;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
    }
    
    .status-icon {
        width: 50px;
        height: 50px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .status-icon i {
        font-size: 1.5rem;
        color: white;
    }
    
    .status-content h6 {
        margin: 0 0 0.25rem 0;
        font-size: 0.9rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
    }
    
    .status-value {
        color: white;
    }
    
    .status-value span {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .status-value small {
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 0.75rem;
    }
    
    /* 状态指示器动画 */
    .status-pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* 手机端适配 */
    @media (max-width: 768px) {
        .sample-grid {
            grid-template-columns: 1fr; /* 手机端单列布局 */
            gap: 0.75rem;
        }
        .sample-card {
            min-height: auto;
        }
        .sample-card .row {
            margin: 0;
        }
        .sample-card .col-md-4,
        .sample-card .col-md-8 {
            padding: 0;
        }
        .sample-image {
            height: auto; /* 改为自动高度 */
            max-height: 150px; /* 限制最大高度 */
            max-width: 100%; /* 限制最大宽度 */
            object-fit: contain; /* 改为contain保持完整图片 */
            object-position: center;
        }
        .sample-content {
            min-height: 120px;
            padding: 0.75rem;
            background: white; /* 确保文字有背景 */
            position: relative;
            z-index: 2;
        }
        .sample-content .card-title {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
        }
        .sample-content .badge {
            font-size: 0.7rem;
        }
    }
    
    /* 小屏幕设备进一步优化 */
    @media (max-width: 576px) {
        .sample-card {
            margin-bottom: 1rem; /* 增加卡片间距 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* 添加阴影增强层次感 */
        }
        .sample-card .row {
            flex-direction: column; /* 垂直排列 */
        }
        .sample-card .col-md-4,
        .sample-card .col-md-8 {
            max-width: 100%;
            flex: 0 0 auto;
        }
        .sample-card .col-md-4 {
            display: flex;
            justify-content: center; /* 图片居中显示 */
            padding: 0.5rem; /* 添加内边距 */
            background: #f8f9fa; /* 添加浅色背景 */
        }
        .sample-image {
            height: auto;
            max-height: 120px; /* 小屏幕进一步限制高度 */
            max-width: 150px; /* 限制最大宽度 */
            object-fit: contain; /* 保持完整图片显示 */
            border-radius: 0.25rem; /* 圆角 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 添加轻微阴影 */
        }
        .sample-content {
            min-height: auto;
            padding: 0.75rem;
            border-radius: 0 0 0.375rem 0.375rem;
            background: white; /* 确保有白色背景 */
            border-top: 1px solid #dee2e6; /* 添加分隔线 */
            position: relative; /* 确保层级 */
            z-index: 1;
        }
        .sample-content .card-title {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #333; /* 确保文字颜色足够深 */
            font-weight: 600; /* 增加字重 */
        }
        .sample-content .badge {
            font-size: 0.75rem;
        }
    }
    
    .sample-content .card-title {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    /* 执行按钮区域优化 */
    .execute-btn-container {
        margin-top: 2rem;
        padding: 1rem 0;
        border-top: 1px solid rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.5);
        backdrop-filter: blur(5px);
    }
    
    @media (max-width: 768px) {
        .execute-btn-container {
            margin-top: 1.5rem;
            padding: 1.5rem 1rem;
            background: white; /* 移除悬浮效果，使用普通背景 */
            border-top: 2px solid #dee2e6; /* 加强分隔线 */
        }
        .execute-btn {
            width: 100%;
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">
        <i class="fas fa-robot me-2"></i>
        ROS2 云台控制面板
    </h1>
    <div>
        <a href="/process_manager" class="btn btn-outline-primary me-2">
            <i class="fas fa-cogs me-1"></i>进程管理
        </a>
        <button class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i>刷新页面
        </button>
    </div>
</div>

<!-- 系统状态横栏 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card status-overview">
            <div class="card-body">
                <div class="row">
                    <!-- PTZ 稳定性状态 -->
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="status-content">
                                <h6>PTZ 稳定性</h6>
                                <div id="ptz-stability-status" class="status-value">
                                    <span id="ptz-stability-text">检查中...</span>
                                    <small id="ptz-stability-time" class="text-muted d-block">--</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PTZ 模式状态 -->
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="status-content">
                                <h6>PTZ 模式</h6>
                                <div id="ptz-mode-status" class="status-value">
                                    <span id="ptz-mode-text">模式2</span>
                                    <small id="ptz-mode-desc" class="text-muted d-block">人脸跟踪+Roll稳定</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 人脸检测状态 -->
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="status-content">
                                <h6>人脸检测</h6>
                                <div id="face-fps-status" class="status-value">
                                    <span id="face-fps-text">0.0fps</span>
                                    <small id="face-fps-desc" class="text-muted d-block">检查中...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 硬件状态 -->
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="status-content">
                                <h6>硬件状态</h6>
                                <div id="hardware-status" class="status-value">
                                    <span id="imu-status" class="d-block" style="font-size: 0.8rem;">
                                        <i class="fas fa-circle text-warning"></i> IMU: 检查中
                                    </span>
                                    <span id="motor-status" class="d-block" style="font-size: 0.8rem;">
                                        <i class="fas fa-circle text-warning"></i> 电机: 检查中
                                    </span>
                                    <span id="camera-status" class="d-block" style="font-size: 0.8rem;">
                                        <i class="fas fa-circle text-warning"></i> 摄像头: 检查中
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 系统温度 -->
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="status-content">
                                <h6>CPU 温度</h6>
                                <div id="cpu-temp-status" class="status-value">
                                    <span id="cpu-temp-text">--°C</span>
                                    <small class="text-muted d-block">处理器温度</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="status-content">
                                <h6>BPU 温度</h6>
                                <div id="bpu-temp-status" class="status-value">
                                    <span id="bpu-temp-text">--°C</span>
                                    <small class="text-muted d-block">神经网络处理器</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="status-content">
                                <h6>DDR 温度</h6>
                                <div id="ddr-temp-status" class="status-value">
                                    <span id="ddr-temp-text">--°C</span>
                                    <small class="text-muted d-block">内存温度</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 样本选择 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>样本选择
                </h5>
                <div>
                    <span class="badge bg-info me-2" id="sample-count">{{ sample_options|length }} 个可用样本</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshSamples()">
                        <i class="fas fa-sync-alt me-1"></i>刷新样本
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="samples-loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在刷新样本列表...</p>
                </div>
                
                <div id="samples-container">
                    {% if sample_options %}
                    <div class="sample-grid" id="sample-grid">
                        {% for sample in sample_options %}
                        <div class="card sample-card" data-sample="{{ sample.name }}" 
                             onclick="selectSample('{{ sample.name }}')">
                            <div class="row g-0 h-100">
                                <div class="col-md-4">
                                    <img src="/sample_images/{{ sample.name }}" 
                                         class="img-fluid rounded-start sample-image" 
                                         alt="{{ sample.name }}"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNNDAgNDBINDBWODBIODBWNDBINDBaIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPjx0ZXh0IHg9IjYwIiB5PSI2NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOUNBM0FGIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">
                                </div>
                                <div class="col-md-8 d-flex">
                                    <div class="card-body sample-content d-flex flex-column justify-content-between">
                                        <div>
                                            <h6 class="card-title">
                                                <i class="fas fa-user-circle me-2"></i>
                                                {{ sample.name.replace('_', ' ') }}
                                            </h6>
                                        </div>
                                        <div class="mt-auto">
                                            {% if sample.name == current_sample %}
                                            <span class="badge bg-success">当前选择</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4" id="no-samples">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <h5>暂无可用样本</h5>
                        <p>请检查 ~/face_detect/detection_output 目录</p>
                        <div class="execute-btn-container">
                            <button class="btn btn-primary" onclick="refreshSamples()">
                                <i class="fas fa-sync-alt me-1"></i>刷新样本列表
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="mt-4 text-center execute-btn-container">
                    <button id="execute-btn" class="btn btn-success execute-btn" onclick="executeCommand()" 
                            {% if not sample_options %}disabled{% endif %}>
                        <i class="fas fa-paper-plane me-2"></i>
                        发布样本命令
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 系统状态和信息 -->
    <div class="col-lg-4">
        <!-- PTZ模式切换 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-cog me-2"></i>PTZ 模式切换
                </h6>
                <span class="badge bg-primary" id="current-mode-badge">模式2</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small">选择操作模式:</label>
                    <div class="btn-group-vertical w-100" role="group">
                        <input type="radio" class="btn-check" name="ptz-mode" id="mode1" value="1">
                        <label class="btn btn-outline-primary" for="mode1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>模式1</strong>
                                    <small class="d-block text-muted">仅云台防抖</small>
                                </div>
                                <i class="fas fa-balance-scale"></i>
                            </div>
                        </label>
                        
                        <input type="radio" class="btn-check" name="ptz-mode" id="mode2" value="2" checked>
                        <label class="btn btn-outline-primary" for="mode2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>模式2</strong>
                                    <small class="d-block text-muted">人脸跟踪+Roll稳定</small>
                                </div>
                                <i class="fas fa-user-check"></i>
                            </div>
                        </label>
                        
                        <input type="radio" class="btn-check" name="ptz-mode" id="mode3" value="3">
                        <label class="btn btn-outline-primary" for="mode3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>模式3</strong>
                                    <small class="d-block text-muted">人脸跟踪+Roll归零</small>
                                </div>
                                <i class="fas fa-crosshairs"></i>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button id="apply-mode-btn" class="btn btn-success w-100" onclick="applyPtzMode()">
                        <i class="fas fa-check me-2"></i>应用模式
                    </button>
                </div>
                
                <!-- 折叠的ROS话题信息 -->
                <div class="mt-3">
                    <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#ptz-topic-details" 
                            aria-expanded="false" aria-controls="ptz-topic-details">
                        <i class="fas fa-chevron-right me-1" id="ptz-topic-icon"></i>
                        <small>ROS话题详情</small>
                    </button>
                    <div class="collapse" id="ptz-topic-details">
                        <div class="ros-topic-info mt-2">
                            <h6 class="small mb-2">
                                <i class="fas fa-satellite-dish me-1"></i>ROS话题
                            </h6>
                            <div class="small">
                                <strong>发布:</strong> <code>/ptz_manager/mode</code><br>
                                <strong>消息类型:</strong> <code>std_msgs/Int32</code><br>
                                <strong>当前模式:</strong> <span id="mode-topic-info">模式2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ROS2 连接状态 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-network-wired me-2"></i>ROS2 连接状态
                </h6>
            </div>
            <div class="card-body">
                <div id="ros-connection-status">
                    <div class="d-flex align-items-center mb-2">
                        <span class="status-indicator status-warning" id="connection-indicator"></span>
                        <span id="connection-text">检查中...</span>
                    </div>
                    <small class="text-muted" id="connection-details">正在连接到 ROS2 节点...</small>
                </div>
                
                <hr>
                
                <!-- 折叠的话题信息 -->
                <div>
                    <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#ros-topic-details" 
                            aria-expanded="false" aria-controls="ros-topic-details">
                        <i class="fas fa-chevron-right me-1" id="ros-topic-icon"></i>
                        <small>话题信息</small>
                    </button>
                    <div class="collapse" id="ros-topic-details">
                        <div class="ros-topic-info mt-2">
                            <h6 class="small mb-2">
                                <i class="fas fa-satellite-dish me-1"></i>话题信息
                            </h6>
                            <div class="small">
                                <strong>订阅:</strong> <code>/ptz_manager/ptz_stable</code><br>
                                <strong>发布:</strong> <code>/sample_face/set_index</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PTZ 详细状态 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-2"></i>PTZ 详细状态
                </h6>
            </div>
            <div class="card-body" style="position: relative;">
                <div id="status-loading" class="loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                
                <div id="ptz-detailed-status">
                    <div class="mb-3">
                        <label class="form-label small">当前状态:</label>
                        <div id="status-text" class="form-control-plaintext">等待数据...</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">最后更新:</label>
                        <div id="status-timestamp" class="form-control-plaintext text-muted">--</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">消息统计:</label>
                        <div id="message-stats" class="form-control-plaintext">
                            <small>接收: <span id="msg-count">0</span> 条</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">目标点信息:</label>
                        <div id="target-point-details" class="form-control-plaintext">
                            <small class="text-muted">等待目标点数据...</small>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline-primary btn-sm w-100" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt me-1"></i>刷新状态
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 命令历史 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>命令历史
                </h6>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearHistory()">
                    <i class="fas fa-trash me-1"></i>清空
                </button>
            </div>
            <div class="card-body">
                <div id="command-history" class="command-history">
                    <div class="text-muted text-center">暂无命令历史</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 操作结果模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">操作结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedSample = '{{ current_sample }}';
    let messageCount = 0;
    let commandHistory = [];
    let currentSamples = {% if sample_options %}{{ sample_options|tojson|safe }}{% else %}[]{% endif %};
    
    // 缓存目标点数据
    let cachedTargetPointData = null;
    let lastTargetPointUpdate = null;
    
    // PTZ模式相关变量
    let currentPtzMode = 2; // 默认模式2
    let modeDescriptions = {
        1: "仅云台防抖",
        2: "人脸跟踪+Roll稳定", 
        3: "人脸跟踪+Roll归零"
    };
    
    // 初始化折叠组件的箭头动画
    function initCollapseAnimations() {
        // PTZ话题详情
        const ptzCollapse = document.getElementById('ptz-topic-details');
        const ptzIcon = document.getElementById('ptz-topic-icon');
        
        if (ptzCollapse && ptzIcon) {
            ptzCollapse.addEventListener('show.bs.collapse', function () {
                ptzIcon.classList.remove('fa-chevron-right');
                ptzIcon.classList.add('fa-chevron-down');
            });
            
            ptzCollapse.addEventListener('hide.bs.collapse', function () {
                ptzIcon.classList.remove('fa-chevron-down');
                ptzIcon.classList.add('fa-chevron-right');
            });
        }
        
        // ROS话题详情
        const rosCollapse = document.getElementById('ros-topic-details');
        const rosIcon = document.getElementById('ros-topic-icon');
        
        if (rosCollapse && rosIcon) {
            rosCollapse.addEventListener('show.bs.collapse', function () {
                rosIcon.classList.remove('fa-chevron-right');
                rosIcon.classList.add('fa-chevron-down');
            });
            
            rosCollapse.addEventListener('hide.bs.collapse', function () {
                rosIcon.classList.remove('fa-chevron-down');
                rosIcon.classList.add('fa-chevron-right');
            });
        }
    }
    
    // 刷新样本列表
    async function refreshSamples() {
        const loading = document.getElementById('samples-loading');
        const container = document.getElementById('samples-container');
        const refreshBtn = document.querySelector('button[onclick="refreshSamples()"]');
        
        // 显示加载状态
        loading.style.display = 'block';
        container.style.display = 'none';
        refreshBtn.disabled = true;
        
        try {
            const response = await fetch('/api/refresh_samples');
            const result = await response.json();
            
            if (result.success) {
                currentSamples = result.samples;
                selectedSample = result.current_sample;
                
                // 更新样本计数
                document.getElementById('sample-count').textContent = `${result.samples.length} 个可用样本`;
                
                // 重新渲染样本网格
                renderSampleGrid(result.samples);
                
                // 显示成功消息
                showResult('成功', result.message, 'success');
            } else {
                showResult('失败', '刷新样本列表失败', 'error');
            }
        } catch (error) {
            console.error('刷新样本失败:', error);
            showResult('错误', `网络错误: ${error.message}`, 'error');
        } finally {
            loading.style.display = 'none';
            container.style.display = 'block';
            refreshBtn.disabled = false;
        }
    }
    
    // 渲染样本网格
    function renderSampleGrid(samples) {
        const container = document.getElementById('samples-container');
        
        if (samples.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4" id="no-samples">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <h5>暂无可用样本</h5>
                    <p>请检查 ~/face_detect/detection_output 目录</p>
                    <div class="execute-btn-container">
                        <button class="btn btn-primary" onclick="refreshSamples()">
                            <i class="fas fa-sync-alt me-1"></i>刷新样本列表
                        </button>
                    </div>
                </div>
            `;
            
            // 禁用执行按钮
            document.getElementById('execute-btn').disabled = true;
            return;
        }
        
        const gridHtml = samples.map(sample => `
            <div class="card sample-card" data-sample="${sample.name}" 
                 onclick="selectSample('${sample.name}')">
                <div class="row g-0 h-100">
                    <div class="col-md-4">
                        <img src="/sample_images/${sample.name}" 
                             class="img-fluid rounded-start sample-image" 
                             alt="${sample.name}"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNNDAgNDBINDBWODBIODBWNDBINDBaIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPjx0ZXh0IHg9IjYwIiB5PSI2NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjOUNBM0FGIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">
                    </div>
                    <div class="col-md-8 d-flex">
                        <div class="card-body sample-content d-flex flex-column justify-content-between">
                            <div>
                                <h6 class="card-title">
                                    <i class="fas fa-user-circle me-2"></i>
                                    ${sample.name.replace(/_/g, ' ')}
                                </h6>
                            </div>
                            <div class="mt-auto">
                                ${sample.name === selectedSample ? '<span class="badge bg-success">当前选择</span>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `<div class="sample-grid" id="sample-grid">${gridHtml}</div>`;
        
        // 启用执行按钮
        document.getElementById('execute-btn').disabled = false;
        
        // 重新选择当前样本
        if (selectedSample) {
            selectSample(selectedSample);
        }
    }
    
    // 选择样本
    function selectSample(sample) {
        // 移除之前的选择
        document.querySelectorAll('.sample-card').forEach(card => {
            card.classList.remove('selected');
            // 移除之前的选择标记
            const badge = card.querySelector('.badge.bg-success');
            if (badge && badge.textContent === '当前选择') {
                badge.remove();
            }
        });
        
        // 添加新选择
        const selectedCard = document.querySelector(`[data-sample="${sample}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            // 添加选择标记
            const cardBody = selectedCard.querySelector('.card-body');
            if (cardBody && !cardBody.querySelector('.badge.bg-success')) {
                cardBody.insertAdjacentHTML('beforeend', '<span class="badge bg-success">当前选择</span>');
            }
        }
        
        selectedSample = sample;
        console.log('选择样本:', sample);
    }
    
    // 执行命令
    async function executeCommand() {
        if (!selectedSample) {
            // 使用简单的alert提示，不显示模态框
            alert('请先选择一个样本');
            return;
        }
        
        const executeBtn = document.getElementById('execute-btn');
        const originalText = executeBtn.innerHTML;
        
        // 显示发送状态
        executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>发送中...';
        
        try {
            const response = await fetch('/api/execute_script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sample: selectedSample
                })
            });
            
            const result = await response.json();
            
            // 更新当前样本
            if (result.current_sample) {
                selectedSample = result.current_sample;
            }
            
            if (result.success) {
                // 命令发送成功，立即恢复按钮且保持可用状态
                executeBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>发布样本命令';
                executeBtn.disabled = false; // 保持按钮可用，不禁用
                
                // 添加到命令历史（发送状态）
                addToHistory(selectedSample, true, '命令已发送');
                
                // 更新状态栏显示发送成功（不使用模态框）
                const currentStatus = document.getElementById('ptz-current-status');
                currentStatus.textContent = `已发送: ${selectedSample}`;
                currentStatus.style.color = '#28a745'; // 绿色表示成功
                
                // 3秒后恢复原始状态
                setTimeout(() => {
                    currentStatus.style.color = '';
                }, 3000);
                
            } else {
                executeBtn.innerHTML = originalText;
                executeBtn.disabled = false;
                addToHistory(selectedSample, false, result.message);
                
                // 显示错误状态（不使用模态框）
                const currentStatus = document.getElementById('ptz-current-status');
                currentStatus.textContent = `发送失败: ${result.message}`;
                currentStatus.style.color = '#dc3545'; // 红色表示失败
                
                // 5秒后恢复原始状态
                setTimeout(() => {
                    currentStatus.style.color = '';
                    currentStatus.textContent = '等待数据...';
                }, 5000);
            }
            
        } catch (error) {
            console.error('执行命令失败:', error);
            executeBtn.innerHTML = originalText;
            executeBtn.disabled = false;
            addToHistory(selectedSample, false, `网络错误: ${error.message}`);
            
            // 显示网络错误（不使用模态框）
            const currentStatus = document.getElementById('ptz-current-status');
            currentStatus.textContent = `网络错误: ${error.message}`;
            currentStatus.style.color = '#dc3545'; // 红色表示错误
            
            // 5秒后恢复原始状态
            setTimeout(() => {
                currentStatus.style.color = '';
                currentStatus.textContent = '等待数据...';
            }, 5000);
        }
    }
    
    // 显示结果模态框
    function showResult(title, message, type) {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const modalTitle = document.getElementById('resultModalTitle');
        const resultContent = document.getElementById('resultContent');
        
        modalTitle.textContent = title;
        
        let iconClass = '';
        let alertClass = '';
        
        switch (type) {
            case 'success':
                iconClass = 'fas fa-check-circle text-success';
                alertClass = 'alert-success';
                break;
            case 'error':
                iconClass = 'fas fa-exclamation-circle text-danger';
                alertClass = 'alert-danger';
                break;
            default:
                iconClass = 'fas fa-info-circle text-info';
                alertClass = 'alert-info';
        }
        
        resultContent.innerHTML = `
            <div class="alert ${alertClass}" role="alert">
                <i class="${iconClass} me-2"></i>
                ${message}
            </div>
        `;
        
        modal.show();
    }
    
    // 添加到命令历史
    function addToHistory(sample, success, message) {
        const timestamp = new Date().toLocaleString();
        const entry = {
            sample,
            success,
            message,
            timestamp
        };
        
        commandHistory.unshift(entry);
        if (commandHistory.length > 50) {
            commandHistory = commandHistory.slice(0, 50);
        }
        
        updateHistoryDisplay();
    }
    
    // 更新历史显示
    function updateHistoryDisplay() {
        const historyContainer = document.getElementById('command-history');
        
        if (commandHistory.length === 0) {
            historyContainer.innerHTML = '<div class="text-muted text-center">暂无命令历史</div>';
            return;
        }
        
        const historyHtml = commandHistory.map(entry => `
            <div class="command-entry">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${entry.sample.replace(/_/g, ' ')}</strong>
                        <span class="badge ${entry.success ? 'bg-success' : 'bg-danger'} ms-2">
                            ${entry.success ? '成功' : '失败'}
                        </span>
                    </div>
                    <small class="timestamp">${entry.timestamp}</small>
                </div>
                <div class="small text-muted mt-1">${entry.message}</div>
            </div>
        `).join('');
        
        historyContainer.innerHTML = historyHtml;
    }
    
    // 清空历史
    function clearHistory() {
        commandHistory = [];
        updateHistoryDisplay();
    }
    
    // 更新 PTZ 状态
    function updatePtzStatus(data) {
        // 更新详细状态
        const statusText = document.getElementById('status-text');
        const statusTimestamp = document.getElementById('status-timestamp');
        const msgCount = document.getElementById('msg-count');
        
        statusText.textContent = data.status || '等待数据...';
        statusTimestamp.textContent = data.timestamp || '--';
        
        if (data.status && data.status !== '等待数据...') {
            messageCount++;
            msgCount.textContent = messageCount;
        }
    }
    
    // 更新 ROS 连接状态（同时更新导航栏和页面状态卡片）
    function updateRosStatus(connected, error) {
        // 更新导航栏状态（来自base模板）
        const navIndicator = document.getElementById('ros-status-indicator');
        const navStatusText = document.getElementById('ros-status-text');
        
        if (navIndicator && navStatusText) {
            if (connected) {
                navIndicator.className = 'ros-status-indicator ros-connected';
                navStatusText.innerHTML = '<i class="fas fa-check-circle me-1"></i>ROS2 已连接';
            } else {
                navIndicator.className = 'ros-status-indicator ros-disconnected';
                const errorMsg = error ? ` (${error})` : '';
                navStatusText.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>ROS2 未连接' + errorMsg;
            }
        }
        
        // 更新页面状态卡片
        const indicator = document.getElementById('connection-indicator');
        const text = document.getElementById('connection-text');
        const details = document.getElementById('connection-details');
        
        if (indicator && text && details) {
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'ROS2 已连接';
                details.textContent = '节点通信正常，话题已订阅';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'ROS2 未连接';
                details.textContent = error || '无法连接到 ROS2 节点';
            }
        }
    }
    
    // 刷新状态
    async function refreshStatus() {
        const loading = document.getElementById('status-loading');
        loading.style.display = 'flex';
        
        try {
            // 获取PTZ状态
            const ptzResponse = await fetch('/api/ptz_status');
            const ptzData = await ptzResponse.json();
            updatePtzStatus(ptzData);
            updateRosStatus(ptzData.ros_connected, ptzData.ros_error);
            
            // 获取人脸帧率状态
            const faceResponse = await fetch('/api/face_fps_status');
            const faceData = await faceResponse.json();
            updateFaceFpsDisplay(faceData);
            
        } catch (error) {
            console.error('刷新状态失败:', error);
        } finally {
            setTimeout(() => {
                loading.style.display = 'none';
            }, 500);
        }
    }
    
    // WebSocket 事件监听
    socket.on('ptz_status_update', function(data) {
        updatePtzStatus(data);
        updatePtzStabilityStatus(data);
    });
    
    // 监听系统温度更新
    socket.on('system_temp_update', function(data) {
        updateSystemTemperature(data);
    });
    
    // 监听目标点数据更新
    socket.on('target_point_update', function(data) {
        console.log('目标点数据更新:', data);
        
        // 缓存目标点数据
        cachedTargetPointData = data;
        lastTargetPointUpdate = new Date().toLocaleString();
        
        // 更新详细状态显示
        updateTargetPointDisplay(data);
    });
    
    // 监听硬件状态更新
    socket.on('hardware_status_update', function(data) {
        console.log('硬件状态更新:', data);
        updateHardwareStatus(data.hardware);
    });
    
    // 更新硬件状态显示
    function updateHardwareStatus(hardwareData) {
        // 更新IMU状态
        const imuStatus = hardwareData.imu;
        const imuElement = document.getElementById('imu-status');
        if (imuElement && imuStatus) {
            const isOnline = imuStatus.status === 'online';
            imuElement.innerHTML = `<i class="fas fa-circle ${isOnline ? 'text-success' : 'text-danger'}"></i> IMU: ${isOnline ? '在线' : '离线'}`;
        }
        
        // 更新电机状态
        const motorStatus = hardwareData.motor;
        const motorElement = document.getElementById('motor-status');
        if (motorElement && motorStatus) {
            const isOnline = motorStatus.status === 'online';
            motorElement.innerHTML = `<i class="fas fa-circle ${isOnline ? 'text-success' : 'text-danger'}"></i> 电机: ${isOnline ? '在线' : '离线'}`;
        }
        
        // 更新相机状态
        const cameraStatus = hardwareData.camera;
        const cameraElement = document.getElementById('camera-status');
        if (cameraElement && cameraStatus) {
            const isOnline = cameraStatus.status === 'online';
            cameraElement.innerHTML = `<i class="fas fa-circle ${isOnline ? 'text-success' : 'text-danger'}"></i> 摄像头: ${isOnline ? '在线' : '离线'}`;
        }
    }
    
    // 更新PTZ稳定性状态（横栏显示）
    function updatePtzStabilityStatus(data) {
        const statusText = document.getElementById('ptz-stability-text');
        const statusTime = document.getElementById('ptz-stability-time');
        const statusContainer = document.getElementById('ptz-stability-status');
        
        if (data && data.status) {
            statusText.textContent = data.status;
            statusTime.textContent = `更新: ${new Date().toLocaleTimeString()}`;
            
            // 根据状态添加动画效果
            if (data.status.includes('稳定') || data.status.includes('stable')) {
                statusContainer.classList.remove('status-pulse');
            } else {
                statusContainer.classList.add('status-pulse');
            }
        } else {
            statusText.textContent = '无数据';
            statusTime.textContent = '--';
        }
    }
    
    // 更新系统温度显示
    function updateSystemTemperature(data) {
        if (data) {
            // CPU 温度
            if (data.cpu_temp !== undefined) {
                document.getElementById('cpu-temp-text').textContent = `${data.cpu_temp}°C`;
            }
            
            // BPU 温度
            if (data.bpu_temp !== undefined) {
                document.getElementById('bpu-temp-text').textContent = `${data.bpu_temp}°C`;
            }
            
            // DDR 温度
            if (data.ddr_temp !== undefined) {
                document.getElementById('ddr-temp-text').textContent = `${data.ddr_temp}°C`;
            }
        }
    }
    
    // 定期获取系统温度（如果WebSocket没有提供）
    function fetchSystemTemperature() {
        fetch('/api/system_temperature')
            .then(response => response.json())
            .then(data => updateSystemTemperature(data))
            .catch(error => {
                console.warn('获取系统温度失败:', error);
                // 设置默认值
                document.getElementById('cpu-temp-text').textContent = '--°C';
                document.getElementById('bpu-temp-text').textContent = '--°C';
                document.getElementById('ddr-temp-text').textContent = '--°C';
            });
    }
    
    // 监听样本确认事件
    socket.on('sample_confirmation', function(data) {
        console.log('样本确认:', data);
        
        if (data.success) {
            // 更新命令历史
            addToHistory(data.sample_name, true, `设置确认成功 (${data.elapsed_time.toFixed(2)}秒)`);
        }
    });
    
    // 更新目标点显示
    function updateTargetPointDisplay(data) {
        const detailsContainer = document.getElementById('target-point-details');
        if (detailsContainer && data) {
            detailsContainer.innerHTML = `
                <div class="small">
                    <strong>当前样本:</strong> ${data.sample_file || '无'}<br>
                    <strong>目标点:</strong> (${data.x}, ${data.y})<br>
                    <strong>相机尺寸:</strong> ${data.camera_width} × ${data.camera_height}<br>
                    <strong>裁剪区域:</strong> ${data.crop_width} × ${data.crop_height} @ (${data.crop_x}, ${data.crop_y})<br>
                    <strong>原始尺寸:</strong> ${data.original_width} × ${data.original_height}<br>
                    <strong>更新时间:</strong> ${data.timestamp}<br>
                    <strong>缓存时间:</strong> ${lastTargetPointUpdate}
                </div>
            `;
        }
    }
    
    // 恢复缓存的目标点数据
    function restoreCachedTargetPointData() {
        if (cachedTargetPointData) {
            console.log('恢复缓存的目标点数据:', cachedTargetPointData);
            updateTargetPointDisplay(cachedTargetPointData);
        } else {
            // 如果没有缓存数据，尝试从服务器获取
            fetchTargetPointData();
        }
    }
    
    // 从服务器获取目标点数据
    function fetchTargetPointData() {
        fetch('/api/target_point_status')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    cachedTargetPointData = data.data;
                    lastTargetPointUpdate = new Date().toLocaleString();
                    updateTargetPointDisplay(data.data);
                }
            })
            .catch(error => {
                console.warn('获取目标点数据失败:', error);
            });
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 设置当前选择的样本
        selectSample(selectedSample);
        
        // 加载初始状态
        refreshStatus();
        
        // 恢复缓存的目标点数据
        restoreCachedTargetPointData();
        
        // 初始获取系统温度
        fetchSystemTemperature();
        
        // 初始化PTZ模式
        initializePtzMode();
        
        // 初始化硬件状态
        initializeHardwareStatus();
        
        // 初始化人脸检测频率
        initializeFaceFps();
        
        // 初始化折叠组件动画
        initCollapseAnimations();
        
        // 每30秒更新一次温度
        setInterval(fetchSystemTemperature, 30000);
        
        // 定期刷新状态
        setInterval(refreshStatus, 30000);
    });
    
    // 初始化PTZ模式
    async function initializePtzMode() {
        try {
            const response = await fetch('/api/ptz_mode');
            const result = await response.json();
            
            if (result.success) {
                currentPtzMode = result.current_mode;
                updatePtzModeDisplay(result.current_mode, result.mode_description);
                updateModeSelection(result.current_mode);
            }
        } catch (error) {
            console.error('初始化PTZ模式失败:', error);
        }
    }
    
    // 应用PTZ模式
    async function applyPtzMode() {
        const selectedMode = document.querySelector('input[name="ptz-mode"]:checked');
        if (!selectedMode) {
            alert('请选择一个模式');
            return;
        }
        
        const mode = parseInt(selectedMode.value);
        const applyBtn = document.getElementById('apply-mode-btn');
        const originalText = applyBtn.innerHTML;
        
        // 显示发送状态
        applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>切换中...';
        applyBtn.disabled = true;
        
        try {
            const response = await fetch('/api/ptz_mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: mode })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentPtzMode = result.current_mode;
                updatePtzModeDisplay(result.current_mode, result.mode_description);
                
                // 显示成功消息
                showResult('成功', result.message, 'success');
                
                // 添加到命令历史
                addToHistory(`PTZ模式${mode}`, true, result.message);
                
            } else {
                showResult('失败', result.message, 'error');
                addToHistory(`PTZ模式${mode}`, false, result.message);
            }
            
        } catch (error) {
            console.error('切换PTZ模式失败:', error);
            showResult('错误', `网络错误: ${error.message}`, 'error');
            addToHistory(`PTZ模式${mode}`, false, `网络错误: ${error.message}`);
        } finally {
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
        }
    }
    
    // 更新PTZ模式显示
    function updatePtzModeDisplay(mode, description) {
        // 更新系统状态横栏
        document.getElementById('ptz-mode-text').textContent = `模式${mode}`;
        document.getElementById('ptz-mode-desc').textContent = description;
        
        // 更新控制卡片
        document.getElementById('current-mode-badge').textContent = `模式${mode}`;
        document.getElementById('mode-topic-info').textContent = `模式${mode}`;
        
        // 更新模式选择
        updateModeSelection(mode);
    }
    
    // 更新模式选择状态
    function updateModeSelection(mode) {
        document.querySelectorAll('input[name="ptz-mode"]').forEach(radio => {
            radio.checked = (parseInt(radio.value) === mode);
        });
    }
    
    // 初始化硬件状态
    function initializeHardwareStatus() {
        // 更新硬件状态显示
        updateHardwareStatus({
            hardware: {
                imu: { status: '检查中' },
                motor: { status: '检查中' },
                camera: { status: '检查中' }
            }
        });
    }
    
    // 初始化人脸检测频率
    async function initializeFaceFps() {
        try {
            const response = await fetch('/api/face_fps_status');
            const result = await response.json();
            
            updateFaceFpsDisplay(result);
        } catch (error) {
            console.error('初始化人脸检测频率失败:', error);
            // 设置默认显示
            updateFaceFpsDisplay({ fps: 0 });
        }
    }
    
    // 更新人脸检测频率显示
    function updateFaceFpsDisplay(data) {
        const fpsText = document.getElementById('face-fps-text');
        const fpsDesc = document.getElementById('face-fps-desc');
        
        if (fpsText && data) {
            const fps = data.fps || 0;
            const isNormal = fps >= 10; // 10fps及以上为正常
            
            // 更新FPS数值
            fpsText.textContent = `${fps.toFixed(1)}fps`;
            
            // 根据FPS状态设置颜色
            if (isNormal) {
                fpsText.className = 'text-success fw-bold';
                fpsDesc.textContent = '正常运行';
            } else {
                fpsText.className = 'text-danger fw-bold';
                fpsDesc.textContent = fps === 0 ? '无数据' : '频率偏低';
            }
        }
    }
    
    // 监听人脸检测帧率更新
    socket.on('face_fps_update', function(data) {
        console.log('人脸检测频率更新:', data);
        updateFaceFpsDisplay(data);
    });
</script>
{% endblock %} 