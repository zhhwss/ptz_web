{% extends "base_ros2.html" %}

{% block title %}视频显示 - PTZ 控制系统 (ROS2){% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 200px); /* 减去导航栏和其他元素的高度 */
        min-height: 600px;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .video-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #f8f9fa;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(248, 249, 250, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: opacity 0.3s ease;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .control-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .status-online {
        background-color: #28a745;
        animation: pulse-green 2s infinite;
    }
    
    .status-offline {
        background-color: #dc3545;
    }
    
    .status-loading {
        background-color: #ffc107;
        animation: pulse-yellow 2s infinite;
    }
    
    @keyframes pulse-green {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    @keyframes pulse-yellow {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .refresh-btn {
        transition: all 0.3s ease;
    }
    
    .refresh-btn:hover {
        transform: translateY(-2px);
    }
    
    .refresh-btn.loading {
        pointer-events: none;
    }
    
    .refresh-btn.loading i {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .video-container {
            height: calc(100vh - 150px);
            min-height: 400px;
        }
        
        .control-panel .card-body {
            padding: 1rem;
        }
        
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem !important;
            margin-bottom: 0.5rem;
        }
    }
    
    /* 全屏模式 */
    .fullscreen-mode .video-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        height: 100vh;
        border-radius: 0;
        border: none;
    }
    
    .fullscreen-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        border: none;
        color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .fullscreen-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary">
        <i class="fas fa-video me-2"></i>
        视频显示 - TogetheROS
    </h1>
    <div>
        <a href="/control" class="btn btn-outline-primary me-2">
            <i class="fas fa-arrow-left me-1"></i>返回控制面板
        </a>
        <button class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i>刷新页面
        </button>
    </div>
</div>

<!-- 控制面板 -->
<div class="card control-panel mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-2">
                    <i class="fas fa-satellite-dish me-2"></i>视频流状态
                </h6>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-loading" id="video-status-indicator"></span>
                    <span id="video-status-text">正在加载视频流...</span>
                </div>
                <small class="text-muted" id="video-status-details">
                    连接到 TogetheROS 视频服务 (端口: 8000)
                </small>
            </div>
            
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light refresh-btn" onclick="refreshVideo()">
                        <i class="fas fa-sync-alt me-1"></i>刷新视频
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="toggleFullscreen()">
                        <i class="fas fa-expand me-1"></i>全屏显示
                    </button>
                    <button type="button" class="btn btn-outline-light" onclick="openInNewTab()">
                        <i class="fas fa-external-link-alt me-1"></i>新标签页
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 视频显示容器 -->
<div class="video-container" id="video-container">
    <!-- 加载覆盖层 -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">加载中...</span>
        </div>
        <h5 class="text-muted">正在加载 TogetheROS 视频流...</h5>
        <p class="text-muted text-center">
            请确保 TogetheROS 服务正在运行<br>
            <small>服务地址: <code id="video-url">http://{{ request.host.split(':')[0] }}:8000/TogetheROS</code></small>
        </p>
    </div>
    
    <!-- 全屏按钮 -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()" title="切换全屏">
        <i class="fas fa-expand" id="fullscreen-icon"></i>
    </button>
    
    <!-- 内嵌视频页面 -->
    <iframe id="video-iframe" class="video-iframe" 
            src="http://{{ request.host.split(':')[0] }}:8000/TogetheROS"
            title="TogetheROS 视频流"
            allowfullscreen>
    </iframe>
</div>

<!-- 说明信息 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>使用说明
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">视频流信息</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>实时视频流显示</li>
                            <li><i class="fas fa-check text-success me-2"></i>支持全屏观看</li>
                            <li><i class="fas fa-check text-success me-2"></i>响应式设计，适配各种设备</li>
                            <li><i class="fas fa-check text-success me-2"></i>自动错误检测和重连</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">操作说明</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-mouse me-2 text-info"></i>点击全屏按钮进入全屏模式</li>
                            <li><i class="fas fa-sync-alt me-2 text-info"></i>使用刷新按钮重新加载视频</li>
                            <li><i class="fas fa-external-link-alt me-2 text-info"></i>在新标签页中打开原始视频页面</li>
                            <li><i class="fas fa-mobile-alt me-2 text-info"></i>支持手机和平板设备访问</li>
                        </ul>
                    </div>
                </div>
                
                <hr>
                
                <div class="alert alert-info mb-0">
                    <h6 class="alert-heading">
                        <i class="fas fa-lightbulb me-2"></i>提示
                    </h6>
                    <p class="mb-2">
                        如果视频无法正常显示，请检查：
                    </p>
                    <ul class="mb-0">
                        <li>TogetheROS 服务是否正在端口 8000 上运行</li>
                        <li>网络连接是否正常</li>
                        <li>浏览器是否支持iframe嵌入</li>
                        <li>防火墙设置是否阻止了连接</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let isFullscreen = false;
    let videoCheckInterval;
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initializeVideo();
        startVideoStatusCheck();
    });
    
    // 初始化视频
    function initializeVideo() {
        const iframe = document.getElementById('video-iframe');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        // 监听iframe加载事件
        iframe.addEventListener('load', function() {
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                updateVideoStatus('online', '视频流已连接', '正在显示 TogetheROS 实时视频');
            }, 1000);
        });
        
        // 监听iframe错误事件
        iframe.addEventListener('error', function() {
            updateVideoStatus('offline', '视频流连接失败', '无法连接到 TogetheROS 服务，请检查服务状态');
        });
        
        // 设置超时检测
        setTimeout(() => {
            if (!loadingOverlay.classList.contains('hidden')) {
                updateVideoStatus('offline', '加载超时', '视频流加载时间过长，请检查网络连接');
            }
        }, 10000);
    }
    
    // 更新视频状态
    function updateVideoStatus(status, text, details) {
        const indicator = document.getElementById('video-status-indicator');
        const statusText = document.getElementById('video-status-text');
        const statusDetails = document.getElementById('video-status-details');
        
        // 移除所有状态类
        indicator.classList.remove('status-online', 'status-offline', 'status-loading');
        
        // 添加新状态类
        indicator.classList.add(`status-${status}`);
        
        // 更新文本
        statusText.textContent = text;
        statusDetails.textContent = details;
    }
    
    // 开始视频状态检查
    function startVideoStatusCheck() {
        videoCheckInterval = setInterval(() => {
            checkVideoService();
        }, 30000); // 每30秒检查一次
    }
    
    // 检查视频服务状态
    async function checkVideoService() {
        try {
            const host = window.location.hostname;
            const response = await fetch(`http://${host}:8000/TogetheROS`, {
                method: 'HEAD',
                mode: 'no-cors'
            });
            
            // 由于是no-cors模式，我们无法获取响应状态
            // 但如果没有抛出错误，说明服务可能是可用的
            console.log('视频服务检查：可能可用');
            
        } catch (error) {
            console.warn('视频服务检查失败:', error);
            updateVideoStatus('offline', '服务检查失败', '无法连接到 TogetheROS 服务');
        }
    }
    
    // 刷新视频
    function refreshVideo() {
        const refreshBtn = document.querySelector('.refresh-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const iframe = document.getElementById('video-iframe');
        
        // 显示加载状态
        refreshBtn.classList.add('loading');
        loadingOverlay.classList.remove('hidden');
        updateVideoStatus('loading', '正在刷新...', '重新连接到 TogetheROS 视频服务');
        
        // 重新加载iframe
        const currentSrc = iframe.src;
        iframe.src = '';
        
        setTimeout(() => {
            iframe.src = currentSrc;
            refreshBtn.classList.remove('loading');
        }, 500);
    }
    
    // 切换全屏
    function toggleFullscreen() {
        const container = document.getElementById('video-container');
        const icon = document.getElementById('fullscreen-icon');
        
        if (!isFullscreen) {
            // 进入全屏
            document.body.classList.add('fullscreen-mode');
            icon.classList.remove('fa-expand');
            icon.classList.add('fa-compress');
            isFullscreen = true;
            
            // 尝试使用浏览器全屏API
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            }
            
        } else {
            // 退出全屏
            document.body.classList.remove('fullscreen-mode');
            icon.classList.remove('fa-compress');
            icon.classList.add('fa-expand');
            isFullscreen = false;
            
            // 退出浏览器全屏
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }
    }
    
    // 监听全屏变化事件
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('msfullscreenchange', handleFullscreenChange);
    
    function handleFullscreenChange() {
        const isDocumentFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
        
        if (!isDocumentFullscreen && isFullscreen) {
            // 用户通过ESC等方式退出了全屏
            document.body.classList.remove('fullscreen-mode');
            document.getElementById('fullscreen-icon').classList.remove('fa-compress');
            document.getElementById('fullscreen-icon').classList.add('fa-expand');
            isFullscreen = false;
        }
    }
    
    // 在新标签页打开
    function openInNewTab() {
        const host = window.location.hostname;
        const url = `http://${host}:8000/TogetheROS`;
        window.open(url, '_blank');
    }
    
    // 键盘快捷键
    document.addEventListener('keydown', function(e) {
        // F11 或 F 键切换全屏
        if (e.key === 'F11' || (e.key === 'f' || e.key === 'F')) {
            e.preventDefault();
            toggleFullscreen();
        }
        
        // R 键刷新视频
        if (e.key === 'r' || e.key === 'R') {
            if (e.ctrlKey) return; // 避免与浏览器刷新冲突
            e.preventDefault();
            refreshVideo();
        }
        
        // ESC 键退出全屏
        if (e.key === 'Escape' && isFullscreen) {
            toggleFullscreen();
        }
    });
    
    // 页面卸载时清理
    window.addEventListener('beforeunload', function() {
        if (videoCheckInterval) {
            clearInterval(videoCheckInterval);
        }
    });
</script>
{% endblock %} 